<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>🔮NgFate - Project Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container-fluid my-4">
      <div class="row">
        <div class="col">
          <h4 class="mb-4 pb-3 border-bottom">🔮NgFate - Project Report</h4>

          <div id="report" hidden>
            <div class="input-group">
              <span class="input-group-text" id="search-icon">🔍</span>
              <input
                id="search"
                type="text"
                class="form-control"
                placeholder="Search modules"
                aria-label="Search"
                aria-describedby="search-icon" />
              <button
                id="btn-search"
                class="btn btn-outline-secondary dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false">
                Module
              </button>
              <ul class="dropdown-menu dropdown-menu-end dropdown-search">
                <li><button class="dropdown-item" type="button">Module</button></li>
                <li><button class="dropdown-item" type="button">Component</button></li>
              </ul>
              <button id="btn-cancel" class="btn btn-outline-secondary" type="button">❌</button>
            </div>

            <div class="mt-3">
              <h6>Modules:</h6>
              <div class="accordion" id="accord-project"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="output.js"></script>
    <script>
      const dvReport = document.getElementById('report');
      const dvProject = document.getElementById('accord-project');
      const txtSearch = document.getElementById('search');
      const btnSearch = document.getElementById('btn-search');
      const btnCancel = document.getElementById('btn-cancel');
      const ddlSearchAll = document.querySelectorAll('.dropdown-search .dropdown-item');

      (function () {
        if (!_modules || !_modules.length) {
          console.log(`The fate is not decided yet!`);
          return;
        }

        txtSearch.addEventListener('keyup', onSearchChange);
        btnCancel.addEventListener('click', onCancelClick);

        ddlSearchAll.forEach(ddl => ddl.addEventListener('click', onSearchDropdownChange));

        dvReport.removeAttribute('hidden');

        loadModules(_modules);
      })();

      function loadModules(modules) {
        dvProject.innerHTML = '';

        for (const module of modules) {
          let compContent = '';
          for (const comp of module.Components) {
            let parentContent = '';
            if (comp.Parents) {
              let parentCompContent = '';
              for (const parent of comp.Parents) {
                parentCompContent += `
                        <div class="accordion-item">
                                                
                            <h2 class="accordion-header" id="header-${parent.Id}">
                                <button
                                    class="accordion-button collapsed"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#collapse-${parent.Id}"
                                    aria-expanded="true"
                                    aria-controls="collapse-${parent.Id}">
                                    ${parent.Name}
                                </button>
                            </h2>

                            <div
                                id="collapse-${parent.Id}"
                                class="accordion-collapse collapse"
                                aria-labelledby="header-${parent.Id}">

                                <div class="accordion-body p-1">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item">
                                            <strong>Name:</strong>
                                            <span>${parent.Name}</span>
                                        </li>
                                        <li class="list-group-item">
                                            <strong>FileName:</strong>
                                            <span>${parent.FileName}</span>
                                        </li>
                                        <li class="list-group-item">
                                            <strong>FilePath:</strong>
                                            <span>${parent.FilePath}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                        </div>
                    `;
              }

              parentContent = `
                    <li class="list-group-item">
                        <strong>Parents:</strong>
                        <div class="accordion mt-2">
                            ${parentCompContent}
                        </div>
                    </li>
                `;
            }

            compContent += `
                <div class="accordion-item">
                                        
                    <h2 class="accordion-header" id="header-${comp.Id}">
                        <button
                            class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-${comp.Id}"
                            aria-expanded="true"
                            aria-controls="collapse-${comp.Id}">
                            ${comp.Name}
                        </button>
                    </h2>

                    <div
                        id="collapse-${comp.Id}"
                        class="accordion-collapse collapse"
                        aria-labelledby="header-${comp.Id}">

                        <div class="accordion-body p-1">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <strong>Name:</strong>
                                    <span>${comp.Name}</span>
                                </li>
                                <li class="list-group-item">
                                    <strong>FileName:</strong>
                                    <span>${comp.FileName}</span>
                                </li>
                                <li class="list-group-item">
                                    <strong>FilePath:</strong>
                                    <span>${comp.FilePath}</span>
                                </li>
                                <li class="list-group-item">
                                    <strong>Routed:</strong>
                                    <span>${comp.Routed}</span>
                                </li>
                                <li class="list-group-item">
                                    <strong>RoutePath:</strong>
                                    <span>${comp.RoutePath}</span>
                                </li>
                                ${parentContent}
                            </ul>
                        </div>
                    </div>

                </div>
            `;
          }

          dvProject.innerHTML += `
                <div class="accordion-item">
                    
                    <h2 class="accordion-header" id="header-${module.Id}">
                        <button
                            class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-${module.Id}"
                            aria-expanded="true"
                            aria-controls="collapse-${module.Id}">
                            ${module.Name}
                        </button>
                    </h2>

                    <div
                        id="collapse-${module.Id}"
                        class="accordion-collapse collapse"
                        aria-labelledby="header-${module.Id}">

                        <div class="accordion-body p-1">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <strong>Name:</strong>
                                    <span>${module.Name}</span>
                                </li>
                                <li class="list-group-item">
                                    <strong>FileName:</strong>
                                    <span>${module.FileName}</span>
                                </li>
                                <li class="list-group-item">
                                    <strong>FilePath:</strong>
                                    <span>${module.FilePath}</span>
                                </li>
                                <li class="list-group-item">
                                    <strong>Components:</strong>
                                    <div class="accordion mt-2">
                                        ${compContent}
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }
      }

      function onSearchChange() {
        const search = this.value?.toLowerCase();
        const type = btnSearch.innerText;

        if (!search) {
          loadModules(_modules);
          return;
        }

        let modules = [];

        if (type === 'Component') {
          const clonedModules = structuredClone(_modules);
          modules = clonedModules.filter(module => {
            const foundComps = module.Components.filter(comp => comp.Name.toLowerCase().includes(search));

            if (foundComps && foundComps.length) {
                module.Components = foundComps;
              return true;
            }

            return false;
          });
        } else {
          modules = _modules.filter(module => module.Name.toLowerCase().includes(search));
        }

        loadModules(modules);
      }

      function onSearchDropdownChange() {
        const type = this.innerText;
        btnSearch.innerText = type;
        txtSearch.value = '';

        txtSearch.setAttribute('placeholder', `Search ${type?.toLowerCase()}`)

        loadModules(_modules);
      }

      function onCancelClick() {
        txtSearch.value = '';
        loadModules(_modules);
      }
    </script>
  </body>
</html>
